# .github/workflows/pr-review-checklist.yml
# -----------------------------------------------------------------------------
# Auto-post (and keep updated) the PR Review Checklist on each pull request.
# - Triggers on PR open/synchronize/reopen and when labels change.
# - Uses pull_request_target so it can comment on PRs from forks.
# - Updates an existing bot comment instead of spamming new ones.
# - Skips if PR has label `no-auto-checklist`.
# -----------------------------------------------------------------------------

name: PR Review Checklist

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, unlabeled]

permissions:
  pull-requests: write
  contents: read

concurrency:
  group: pr-review-checklist-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  post-checklist:
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'no-auto-checklist') }}
    runs-on: ubuntu-latest

    steps:
      - name: Build checklist body
        id: body
        run: |
          cat > body.md <<'MD'
          <!-- SPECTRAMIND_V50_REVIEW_CHECKLIST:DO-NOT-REMOVE -->
          # âœ… SpectraMind V50 â€” PR Review Checklist (Quick Triage)

          This **one-pager** gives reviewers a **fast triage table** for pull requests.  
          Use alongside the full **[Pull Request Review Guide](.github/PULL_REQUEST_REVIEW_GUIDE.md)**.

          Mark âœ… = pass, âŒ = fail, âš ï¸ = needs clarification.

          ---

          ## ğŸ“ Metadata
          | Check | Status |
          |-------|--------|
          | PR title imperative & concise | â˜ |
          | Linked to issue(s)/milestones | â˜ |

          ---

          ## ğŸ¯ Summary & Motivation
          | Check | Status |
          |-------|--------|
          | Rationale clear & scientific context provided | â˜ |
          | Impact on Î¼/Ïƒ, GLL, calibration, runtime, symbolic rules explained | â˜ |

          ---

          ## âš™ï¸ Design & Reproducibility
          | Check | Status |
          |-------|--------|
          | CLI commands exact & runnable (`spectramind â€¦`) | â˜ |
          | Hydra config diffs shown, no hidden constants | â˜ |
          | DVC stages updated & `dvc repro` passes | â˜ |
          | Run hash recorded in `logs/v50_debug_log.md` | â˜ |

          ---

          ## ğŸ”¬ Scientific Integrity & Diagnostics
          | Check | Status |
          |-------|--------|
          | Metrics table filled (baseline vs new) | â˜ |
          | Dashboard/plots attached (HTML, UMAP/t-SNE, FFT, GLL heatmap) | â˜ |
          | Symbolic/physics rules respected (smoothness, nonnegativity, priors) | â˜ |

          ---

          ## ğŸ”„ Compatibility & Risk
          | Check | Status |
          |-------|--------|
          | Breaking changes listed (CLI/config/schema) | â˜ |
          | Migration/fallback path documented | â˜ |
          | Risk assessment & mitigation provided | â˜ |

          ---

          ## ğŸ§ª Tests & Validation
          | Check | Status |
          |-------|--------|
          | Unit tests added/updated, pytest green | â˜ |
          | `spectramind selftest --fast/--deep` passes | â˜ |
          | CI smoke run passes | â˜ |
          | Determinism checked (seeds consistent) | â˜ |

          ---

          ## âš¡ Performance & Runtime
          | Check | Status |
          |-------|--------|
          | Runtime â‰¤ 9h Kaggle limit | â˜ |
          | Memory/VRAM within container limits | â˜ |
          | Variance across seeds acceptable | â˜ |

          ---

          ## ğŸ›¡ï¸ Security & Compliance
          | Check | Status |
          |-------|--------|
          | No secrets/keys in code/configs | â˜ |
          | New deps/actions pinned to versions/SHAs | â˜ |
          | Licenses respected, no PII introduced | â˜ |

          ---

          ## ğŸ“š Docs & Changelog
          | Check | Status |
          |-------|--------|
          | README/docs updated if user-facing | â˜ |
          | CLI `--help` accurate | â˜ |
          | Configs commented inline | â˜ |
          | CHANGELOG updated | â˜ |

          ---

          ## ğŸš€ Post-Merge Tasks
          | Check | Status |
          |-------|--------|
          | CI pipeline green on main | â˜ |
          | Run hash tagged & artifacts published | â˜ |
          | Dashboard backfilled & linked | â˜ |
          | Stakeholders notified / issues closed | â˜ |

          ---

          ### ğŸ”­ Mission Reminder
          **Every PR must be reproducible, validated, and scientifically safe before merge.**
          MD
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat body.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create or update checklist comment
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const body = core.getInput('body', { required: true });
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            // Unique marker to find/update our own comment
            const marker = '<!-- SPECTRAMIND_V50_REVIEW_CHECKLIST:DO-NOT-REMOVE -->';

            // List existing comments and try to find our marker
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number, per_page: 100
            });

            const botLogin = (await github.rest.users.getAuthenticated()).data.login;
            let existing = comments.find(c =>
              c.user?.login === botLogin && c.body && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner, repo, comment_id: existing.id, body
              });
              core.info(`Updated existing checklist comment #${existing.id}`);
            } else {
              const res = await github.rest.issues.createComment({
                owner, repo, issue_number, body
              });
              core.info(`Created new checklist comment #${res.data.id}`);
            }
        with:
          body: ${{ steps.body.outputs.body }}