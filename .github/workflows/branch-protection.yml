name: "Apply Branch Protection & Enable Auto-merge"

on:
  workflow_dispatch:
    inputs:
      default_branch:
        description: "Branch to protect (e.g., main)"
        required: true
        default: "main"
      required_checks_csv:
        description: "Comma-separated list of required check names (exact contexts)"
        required: true
        default: "Lint & Static Analysis,Security Scan,Submission Validation,Dependabot Auto-Merge"

permissions:
  contents: read

jobs:
  protect:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.BRANCH_PROTECT_PAT }}
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      DEFAULT_BRANCH: ${{ github.event.inputs.default_branch }}
      REQUIRED_CHECKS_CSV: ${{ github.event.inputs.required_checks_csv }}
    steps:
      - name: Check gh auth
        run: gh auth status

      - name: Enable repository auto-merge
        run: |
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${OWNER}/${REPO} \
            -f allow_auto_merge=true

      - name: Build protection payload
        id: build
        shell: bash
        run: |
          # Convert CSV -> JSON array
          IFS=',' read -ra ARR <<< "$REQUIRED_CHECKS_CSV"
          JSON_ARRAY=$(printf '"%s",' "${ARR[@]}")
          JSON_ARRAY="[${JSON_ARRAY%,}]"

          cat > body.json <<JSON
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ${JSON_ARRAY}
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true,
              "require_last_push_approval": false
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false,
            "required_conversation_resolution": true,
            "required_linear_history": false,
            "lock_branch": false
          }
          JSON

      - name: Apply protection
        run: |
          gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            /repos/${OWNER}/${REPO}/branches/${DEFAULT_BRANCH}/protection \
            --input body.json

      - name: Summary
        run: |
          echo "✅ Auto-merge enabled for ${OWNER}/${REPO}"
          echo "✅ Branch protection applied to ${DEFAULT_BRANCH}"
          echo "✅ Required checks: ${REQUIRED_CHECKS_CSV}"
