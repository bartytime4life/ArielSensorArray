# .dvc/plots.yaml
# ==============================================================================
# SpectraMind V50 — DVC Plots Configuration (Upgraded)
# ------------------------------------------------------------------------------
# Purpose
#   Centralize all plot definitions used by `dvc plots show/diff` for CI and local dev.
#   These entries can be referenced or merged into dvc.yaml stages, and also
#   consumed directly with:
#     dvc plots show --targets .dvc/plots.yaml
#     dvc plots diff  --targets .dvc/plots.yaml HEAD~1
#
# Notes
#   • DVC supports CSV/TSV/JSON. For JSON, fields must be addressable as keys.
#   • Each plot entry below declares x/y columns/keys and a vega-lite template.
#   • Paths/globs point to standard SpectraMind V50 outputs written by the CLI.
#   • To add or rename a plot, keep the "id" unique and "rev_lock" untouched (DVC sets it).
#
# Templates
#   Custom vega-lite templates are stored under: plots/templates/vega/*.json
#   If a template is not found, DVC falls back to its default scheme.
# ==============================================================================

version: 1

templates:
  # Line plots (loss/metrics over steps or epochs)
  line:            plots/templates/vega/line.json
  line_dark:       plots/templates/vega/line_dark.json
  # Scatter with identity guide (for calibration, residual vs sigma, etc.)
  scatter_guide:   plots/templates/vega/scatter_guide.json
  # Histogram
  hist:            plots/templates/vega/hist.json
  # Heatmap (e.g., per-bin GLL)
  heatmap:         plots/templates/vega/heatmap.json

# ------------------------------------------------------------------------------
# Plot groups
# - Each entry defines a single “target” for DVC plots (file + axes + template).
# - Use `dvc plots show .dvc/plots.yaml:train_loss` to render a single plot by id.
# ------------------------------------------------------------------------------

plots:

  # ===========================
  # TRAINING / VALIDATION LINES
  # ===========================
  - id: train_loss
    title: "Training Loss vs Step"
    x: step
    y: loss
    # Accept JSON or CSV; the CLI writes JSON by default at this path.
    path: outputs/metrics/train_metrics.json
    template: line
    x_label: "Step"
    y_label: "Loss"
    smooth: true

  - id: val_loss
    title: "Validation Loss vs Step"
    x: step
    y: val_loss
    path: outputs/metrics/val_metrics.json
    template: line
    x_label: "Step"
    y_label: "Val Loss"
    smooth: true

  - id: lr_schedule
    title: "Learning Rate vs Step"
    x: step
    y: lr
    path: outputs/metrics/train_metrics.json
    template: line
    x_label: "Step"
    y_label: "LR"
    smooth: false

  - id: gll_over_time
    title: "Gaussian Log-Likelihood vs Step"
    x: step
    y: gll
    path: outputs/metrics/val_metrics.json
    template: line
    x_label: "Step"
    y_label: "GLL (↑ better)"
    smooth: true

  # ===========================
  # CALIBRATION / RESIDUAL PLOTS
  # ===========================
  - id: residual_hist
    title: "Residuals Histogram | (μ - y)"
    path: outputs/diagnostics/calibration/residuals.csv
    y: residual      # column in CSV
    template: hist
    bins: 60
    x_label: "Residual (μ - y)"
    y_label: "Count"

  - id: sigma_hist
    title: "Predicted σ Histogram"
    path: outputs/diagnostics/calibration/residuals.csv
    y: sigma
    template: hist
    bins: 60
    x_label: "Predicted σ"
    y_label: "Count"

  - id: residual_vs_sigma
    title: "|Residual| vs σ"
    path: outputs/diagnostics/calibration/residuals.csv
    x: sigma
    y: abs_residual
    template: scatter_guide   # draws y=x guide for visual calibration check
    x_label: "Predicted σ"
    y_label: "|μ - y|"

  - id: reliability_curve
    title: "Reliability Curve (Calibration)"
    path: outputs/diagnostics/calibration/reliability.csv
    x: expected
    y: observed
    template: scatter_guide   # diagonal = perfect calibration
    x_label: "Expected Coverage"
    y_label: "Observed Coverage"

  # ===========================
  # PER-BIN / PER-WAVELENGTH HEATMAPS
  # ===========================
  - id: gll_heatmap
    title: "Per-Bin GLL Heatmap"
    path: outputs/diagnostics/gll_per_bin.csv
    # Expected columns: bin, step (or epoch), gll
    heatmap:
      x: bin
      y: step
      color: gll
      colorbar_label: "GLL"
    template: heatmap

  - id: coverage_heatmap
    title: "Per-Bin Coverage Heatmap"
    path: outputs/diagnostics/coverage_per_bin.csv
    heatmap:
      x: bin
      y: threshold      # e.g., 50%, 80%, 90% lines evaluated
      color: coverage
      colorbar_label: "Coverage"
    template: heatmap

  # ===========================
  # FFT / SPECTRAL DIAGNOSTICS
  # ===========================
  - id: fft_power
    title: "FFT Power (μ spectrum)"
    path: outputs/diagnostics/fft/power.csv
    x: freq
    y: power
    template: line
    x_label: "Frequency"
    y_label: "Power"
    smooth: false
    log_x: false
    log_y: true

  # ===========================
  # UMAP / t-SNE OVERVIEWS (SCATTER)
  # ===========================
  - id: umap_latents
    title: "UMAP Latents (colored by cluster)"
    path: outputs/diagnostics/umap/umap_latents.csv
    x: x
    y: y
    color: cluster       # optional field; if absent, template ignores
    template: scatter_guide
    x_label: "UMAP-1"
    y_label: "UMAP-2"

  - id: tsne_latents
    title: "t-SNE Latents (colored by entropy)"
    path: outputs/diagnostics/tsne/tsne_latents.csv
    x: x
    y: y
    color: entropy
    template: scatter_guide
    x_label: "t-SNE-1"
    y_label: "t-SNE-2"

# ------------------------------------------------------------------------------
# Globs (optional convenience)
# You can reference these as `--targets .dvc/plots.yaml:group:<name>`
# to show all plots in a group at once.
# ------------------------------------------------------------------------------
groups:
  training:
    - train_loss
    - val_loss
    - lr_schedule
    - gll_over_time
  calibration:
    - residual_hist
    - sigma_hist
    - residual_vs_sigma
    - reliability_curve
  binwise:
    - gll_heatmap
    - coverage_heatmap
  spectral:
    - fft_power
  embedding:
    - umap_latents
    - tsne_latents

# ------------------------------------------------------------------------------
# Rendering hints
#   These are generic knobs some templates respect (optional).
#   DVC ignores unknown keys, so it’s safe to keep them here.
# ------------------------------------------------------------------------------
hints:
  dark_mode: false
  point_size: 28
  line_width: 2
  palette: "viridis"
  # If your CI uses dark backgrounds, set:
  # dark_mode: true
