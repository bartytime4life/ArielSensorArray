# configs/calib/method/temperature.yaml
# ==============================================================================
# ðŸŒ World Discovery Engine (WDE)
# Temperature Scaling Calibration Method (Closed-Form)
# ------------------------------------------------------------------------------
# Purpose:
#   Calibrate predictive uncertainty (Ïƒ) by scaling logits or variance
#   with a learned temperature factor T.
#
# Features:
#   â€¢ Supports global or per-bin temperature scaling
#   â€¢ Optional L2 regularization toward T=1.0 (to avoid degenerate scaling)
#   â€¢ Safe clamping of Ïƒ to avoid numerical instability
#   â€¢ Fallback strategies if calibration targets unavailable
#   â€¢ Diagnostics export (plots, JSON summary, coverage metrics)
#   â€¢ Reproducibility controls (seeded, deterministic)
# ==============================================================================

method: "temperature"

temperature:
  # ---- Mode ----
  mode: "global"              # options: global | perbin | perregion
  fit_method: "closed_form"   # closed_form | grid_search | nll_opt

  # ---- Regularization ----
  l2: 0.0                     # L2 penalty toward T=1.0 (0 = off)
  l2_schedule: null            # optional: schedule {start, end, decay}

  # ---- Safety & Stability ----
  min_sigma: 1e-8              # clamp floor for Ïƒ
  max_sigma: 1e+3              # optional upper clamp
  fallback_T: 1.0              # fallback value if no calibration possible
  allow_negative: false        # if false, enforce T > 0

  # ---- Diagnostics ----
  save_calibrated: "outputs/calibration/calibrated_preds.csv"
  save_temperature: "outputs/calibration/temperature_values.json"
  save_plots: true
  diagnostics_dir: "outputs/diagnostics/temperature/"
  metrics:                     # metrics to compute on calibration set
    - ece                     # Expected Calibration Error
    - nll                     # Negative Log-Likelihood
    - brier                   # Brier score
    - coverage                # coverage vs confidence

  # ---- Reproducibility ----
  random_seed: 42
  deterministic: true

  # ---- Metadata ----
  version: "1.1"
  provenance: "configs/calib/method/temperature.yaml"
  notes: |
    Temperature scaling corrects model calibration by scaling logits/Ïƒ.
    Modes:
      - global   : single T across all bins
      - perbin   : distinct T for each output bin (more flexible)
      - perregion: group bins by region (e.g., molecular, wavelength, AOI)
    Fit methods:
      - closed_form: analytic solution (fast, reliable baseline)
      - grid_search: brute force search for T minimizing NLL
      - nll_opt   : gradient-based optimization of NLL loss
    Regularization:
      - L2 penalty keeps T near 1.0, preventing over-scaling
    Diagnostics:
      - Produces plots of pre/post calibration reliability diagrams
      - Exports JSON with fitted T values and summary metrics
    This ensures reproducibility, CI/CD compatibility, and Kaggle runtime safety.
