# configs/calib/method/temperature.yaml
# ==============================================================================
# 🌡️ Temperature Drift Correction — Method Config
# Purpose
#   Correct detector and instrument response variations due to temperature
#   fluctuations during observation. Compensates for gain shifts, bias drift,
#   and wavelength calibration offsets induced by thermal instability.
# Usage
#   Composed by calib/nominal.yaml in the calibration kill chain.
#   Override example:
#     spectramind calibrate calib.method.temperature.enabled=false
# ==============================================================================

temperature:
  enabled: true

  # Source of temperature telemetry
  telemetry_file: "calib/temperature/telemetry.csv"   # CSV with time vs temperature
  column_map:
    time: "timestamp"                                # time column in telemetry
    detector_temp: "detector_C"                      # detector temperature column
    optics_temp: "optics_C"                          # optics temperature column

  # Interpolation of telemetry to match science frames
  interpolation:
    method: "linear"          # options: linear | spline | nearest
    fill_extrapolate: true    # allow extrapolation beyond telemetry bounds
    smoothing_window: 15      # moving average window (seconds) to reduce noise

  # Gain and bias correction model
  gain_model:
    type: "linear"            # options: linear | polynomial | lookup
    coefficients: [1.0, 0.002]   # example: gain = a0 + a1 * (ΔT)
    reference_temp: 20.0      # °C baseline reference
  bias_model:
    type: "linear"
    coefficients: [0.0, 0.01] # DN offset per °C
    reference_temp: 20.0

  # Wavelength calibration drift correction
  wavelength_drift:
    enabled: true
    model: "polynomial"       # options: polynomial | spline
    order: 2
    reference_temp: 20.0      # °C baseline reference
    coeffs: [0.0, 0.05, -0.002] # Δλ shift per ΔT (example in nm/°C)

  # Outlier rejection for telemetry
  outliers:
    sigma_clip: 4.0           # reject temperature points >4σ from trend
    max_iter: 5

  # Optional external correction map
  correction_map: "calib/temperature/correction_table.npy"  
  use_correction_map: false   # if true, apply lookup-table correction instead of models

  notes: |
    Temperature fluctuations affect both detector electronics (bias/gain drift)
    and optical alignment (wavelength calibration). This method interpolates
    temperature telemetry to science frame timestamps, models gain/bias drift,
    and applies wavelength shift corrections. For best results, reference
    coefficients should be calibrated in lab using flat-field exposures and
    arc-lamp wavelength standards.
