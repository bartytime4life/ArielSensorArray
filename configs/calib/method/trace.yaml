# configs/calib/method/trace.yaml
# ==============================================================================
# üìè Trace Normalization ‚Äî Method Config (Upgraded, Mission-Grade)
# Purpose
#   Normalize extracted spectral traces (1D profiles from 2D detector images)
#   to remove baseline drift, flat background, and instrument throughput bias.
#   Supports FGS1 vs AIRS asymmetry, hybrid detrend, FFT options, and diagnostics.
# Usage
#   Composed by calib/nominal.yaml / fast.yaml / strict.yaml in the kill chain.
#   Example override:
#     spectramind calibrate calib.method.trace.strategy=fft
# ==============================================================================

trace:
  enabled: true

  # ---------------------------------------------------------------------------
  # General strategy
  # ---------------------------------------------------------------------------
  strategy: "polynomial"          # options: polynomial | spline | median | hybrid | fft

  # ---------------------------------------------------------------------------
  # Polynomial baseline fitting
  # ---------------------------------------------------------------------------
  polynomial:
    order: 3                      # polynomial order for baseline fitting
    robust: true                  # robust fitting (Huber or RANSAC)
    window: 51                    # moving window size for local estimation

  # ---------------------------------------------------------------------------
  # Spline baseline fitting
  # ---------------------------------------------------------------------------
  spline:
    knots: 20                     # number of spline knots
    smoothing_factor: 0.5         # 0 = exact interpolation

  # ---------------------------------------------------------------------------
  # Median filter baseline
  # ---------------------------------------------------------------------------
  median:
    kernel_size: 5                # odd integer
    iterative: true               # repeat until convergence

  # ---------------------------------------------------------------------------
  # Hybrid blending (polynomial + spline or median)
  # ---------------------------------------------------------------------------
  hybrid:
    primary: "polynomial"
    secondary: "spline"
    blend_weight: 0.7             # primary vs secondary weight

  # ---------------------------------------------------------------------------
  # FFT-based detrending (frequency-domain baseline removal)
  # ---------------------------------------------------------------------------
  fft:
    cutoff_hz: 0.01               # low-pass cutoff in normalized freq
    detrend_mode: "highpass"      # options: highpass | bandstop
    window: "hann"                # FFT window function
    preserve_transit_band: true   # keep transit-scale frequencies

  # ---------------------------------------------------------------------------
  # Instrument-aware settings
  # ---------------------------------------------------------------------------
  instrument:
    fgs1:
      extra_weight: 58.0          # aligns with challenge metric
      prefer_strategy: "polynomial"
    airs:
      prefer_strategy: "spline"
      regional_overrides: true    # allow detector-region tuning

  # ---------------------------------------------------------------------------
  # Edge handling
  # ---------------------------------------------------------------------------
  edges:
    extend: true
    pad: 16

  # ---------------------------------------------------------------------------
  # Outlier rejection
  # ---------------------------------------------------------------------------
  outliers:
    sigma_clip: 4.0
    max_iter: 5

  # ---------------------------------------------------------------------------
  # Throughput correction
  # ---------------------------------------------------------------------------
  throughput_correction: true
  throughput_profile: "calib/trace/throughput.npy"

  # ---------------------------------------------------------------------------
  # Diagnostics & symbolic hooks
  # ---------------------------------------------------------------------------
  diagnostics:
    save_plots: true
    export_residuals: true
    symbolic_overlay: true        # allow symbolic rule checks on residuals
    fft_diagnostics: true         # export FFT power spectra before/after detrend
    coverage_check: true          # per-bin coverage diagnostics (COREL-ready)

  notes: |
    Trace normalization is critical for robust transit extraction.
    - Polynomial: fast, stable; works well for FGS1.
    - Spline: flexible for AIRS wavelength-dependent baselines.
    - Median: robust against cosmic rays & spikes.
    - FFT: removes low-frequency drifts in frequency domain [oai_citation:1‚Ä°FFT and UMAP_ A Comprehensive Technical Reference.pdf](file-service://file-KH1edKdSQWaqiLiUkKdtoW).
    - Hybrid: combine methods for challenging systematics.
    Instrument-aware tuning allows FGS1 emphasis (weighted ‚âà58√ó) [oai_citation:2‚Ä°FGS1 Binning Strategies in Signal Processing and Machine Learning.pdf](file-service://file-ByCYzh8yGePmRDrGaJZicj).
    Throughput correction ensures flux calibration across wavelength.
    Diagnostics export symbolic overlays, FFT spectra, and residuals for audit.