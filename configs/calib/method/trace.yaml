# configs/calib/method/trace.yaml
# ==============================================================================
# 📏 Trace Normalization — Method Config
# Purpose
#   Normalize extracted spectral traces (1D profiles from 2D detector images)
#   to remove baseline drift, flat background, and instrument throughput bias.
# Usage
#   Composed by calib/nominal.yaml in the calibration kill chain.
#   Override example:
#     spectramind calibrate calib.method.trace.strategy=polynomial
# ==============================================================================

trace:
  enabled: true

  # Normalization strategy for extracted spectral traces
  strategy: "polynomial"          # options: polynomial | spline | median | hybrid

  # Polynomial normalization settings
  polynomial:
    order: 3                      # polynomial order for baseline fitting
    robust: true                  # use robust fitting (RANSAC or Huber loss)
    window: 51                    # moving window size for local baseline estimation

  # Spline normalization settings
  spline:
    knots: 20                     # number of spline knots across the trace
    smoothing_factor: 0.5         # regularization weight (0 = interpolate exactly)

  # Median filtering (useful for removing outliers & cosmic rays)
  median:
    kernel_size: 5                # odd integer, size of moving median window
    iterative: true               # repeat median filtering until convergence

  # Hybrid strategy (combine polynomial + spline or median)
  hybrid:
    primary: "polynomial"
    secondary: "spline"
    blend_weight: 0.7             # weight applied to primary vs secondary normalization

  # Edge handling for normalization
  edges:
    extend: true                  # extrapolate fit beyond trace boundaries
    pad: 16                       # number of pixels to pad before fitting

  # Outlier rejection during baseline estimation
  outliers:
    sigma_clip: 4.0               # reject pixels >4σ from baseline fit
    max_iter: 5                   # maximum rejection iterations

  # Throughput normalization
  throughput_correction: true     # normalize by instrument throughput profile if available
  throughput_profile: "calib/trace/throughput.npy"  # external throughput file path

  notes: |
    Trace normalization removes low-frequency trends in extracted spectra.
    Polynomial is fast and stable, spline is flexible, and median is robust
    to cosmic rays. Hybrid can combine methods for challenging datasets.
    Throughput correction ensures relative flux calibration across wavelength.
